{"version":3,"sources":["../src/useTypingAnnounce/useTypingAnnounce.ts"],"sourcesContent":["import * as React from 'react';\nimport { useTimeout } from '@fluentui/react-utilities';\nimport { useAnnounce, useFluent_unstable as useFluent } from '@fluentui/react-shared-contexts';\nimport type { AnnounceOptions } from '@fluentui/react-shared-contexts';\nimport { AriaLiveAnnounceFn } from '../AriaLiveAnnouncer/AriaLiveAnnouncer.types';\n\ntype Message = {\n  message: string;\n  options: AnnounceOptions;\n};\n\nconst valueMutationOptions = {\n  attributes: true,\n  subtree: true,\n  characterData: true,\n  attributeFilter: ['value'],\n};\n\ninterface TypingAnnounceReturn<TInputElement extends HTMLElement = HTMLElement> {\n  typingAnnounce: AriaLiveAnnounceFn;\n  inputRef: React.RefObject<TInputElement>;\n}\n\nexport function useTypingAnnounce<\n  TInputElement extends HTMLElement = HTMLElement,\n>(): TypingAnnounceReturn<TInputElement> {\n  const { targetDocument } = useFluent();\n  const { announce } = useAnnounce();\n\n  const inputRef = React.useRef<TInputElement>(null);\n  const observer = React.useRef<MutationObserver>();\n  const [setTypingTimeout, clearTypingTimeout] = useTimeout();\n  const messageQueue = React.useRef<Message[]>([]);\n\n  const callback: MutationCallback = React.useCallback(\n    (mutationList, mutationObserver) => {\n      setTypingTimeout(() => {\n        messageQueue.current.forEach(({ message, options }) => {\n          announce(message, options);\n        });\n        messageQueue.current.length = 0;\n        mutationObserver.disconnect();\n      }, 500);\n    },\n    [announce, setTypingTimeout],\n  );\n\n  const typingAnnounce: AriaLiveAnnounceFn = React.useCallback(\n    (message: string, options: AnnounceOptions = {}) => {\n      messageQueue.current.push({ message, options });\n\n      if (inputRef.current && observer.current) {\n        observer.current.observe(inputRef.current, valueMutationOptions);\n      }\n\n      setTypingTimeout(() => {\n        observer.current && callback([], observer.current);\n      }, 500);\n    },\n    [callback, inputRef, setTypingTimeout],\n  );\n\n  React.useEffect(() => {\n    const win = targetDocument?.defaultView;\n    if (!win) {\n      return;\n    }\n\n    if (!observer.current) {\n      observer.current = new win.MutationObserver(callback);\n    }\n\n    return () => {\n      // Clean up the observer when the component unmounts\n      if (observer.current) {\n        observer.current.disconnect();\n        clearTypingTimeout();\n      }\n    };\n  }, [callback, clearTypingTimeout, targetDocument]);\n\n  return { typingAnnounce, inputRef };\n}\n"],"names":["useTypingAnnounce","valueMutationOptions","attributes","subtree","characterData","attributeFilter","targetDocument","useFluent","announce","useAnnounce","inputRef","React","useRef","observer","setTypingTimeout","clearTypingTimeout","useTimeout","messageQueue","callback","useCallback","mutationList","mutationObserver","current","forEach","message","options","length","disconnect","typingAnnounce","push","observe","useEffect","win","defaultView","MutationObserver"],"mappings":";;;;+BAuBgBA;;;eAAAA;;;;iEAvBO;gCACI;qCACkC;AAS7D,MAAMC,uBAAuB;IAC3BC,YAAY;IACZC,SAAS;IACTC,eAAe;IACfC,iBAAiB;QAAC;KAAQ;AAC5B;AAOO,SAASL;IAGd,MAAM,EAAEM,cAAc,EAAE,GAAGC,IAAAA,uCAAS;IACpC,MAAM,EAAEC,QAAQ,EAAE,GAAGC,IAAAA,gCAAW;IAEhC,MAAMC,WAAWC,OAAMC,MAAM,CAAgB;IAC7C,MAAMC,WAAWF,OAAMC,MAAM;IAC7B,MAAM,CAACE,kBAAkBC,mBAAmB,GAAGC,IAAAA,0BAAU;IACzD,MAAMC,eAAeN,OAAMC,MAAM,CAAY,EAAE;IAE/C,MAAMM,WAA6BP,OAAMQ,WAAW,CAClD,CAACC,cAAcC;QACbP,iBAAiB;YACfG,aAAaK,OAAO,CAACC,OAAO,CAAC,CAAC,EAAEC,OAAO,EAAEC,OAAO,EAAE;gBAChDjB,SAASgB,SAASC;YACpB;YACAR,aAAaK,OAAO,CAACI,MAAM,GAAG;YAC9BL,iBAAiBM,UAAU;QAC7B,GAAG;IACL,GACA;QAACnB;QAAUM;KAAiB;IAG9B,MAAMc,iBAAqCjB,OAAMQ,WAAW,CAC1D,CAACK,SAAiBC,UAA2B,CAAC,CAAC;QAC7CR,aAAaK,OAAO,CAACO,IAAI,CAAC;YAAEL;YAASC;QAAQ;QAE7C,IAAIf,SAASY,OAAO,IAAIT,SAASS,OAAO,EAAE;YACxCT,SAASS,OAAO,CAACQ,OAAO,CAACpB,SAASY,OAAO,EAAErB;QAC7C;QAEAa,iBAAiB;YACfD,SAASS,OAAO,IAAIJ,SAAS,EAAE,EAAEL,SAASS,OAAO;QACnD,GAAG;IACL,GACA;QAACJ;QAAUR;QAAUI;KAAiB;IAGxCH,OAAMoB,SAAS,CAAC;QACd,MAAMC,MAAM1B,2BAAAA,qCAAAA,eAAgB2B,WAAW;QACvC,IAAI,CAACD,KAAK;YACR;QACF;QAEA,IAAI,CAACnB,SAASS,OAAO,EAAE;YACrBT,SAASS,OAAO,GAAG,IAAIU,IAAIE,gBAAgB,CAAChB;QAC9C;QAEA,OAAO;YACL,oDAAoD;YACpD,IAAIL,SAASS,OAAO,EAAE;gBACpBT,SAASS,OAAO,CAACK,UAAU;gBAC3BZ;YACF;QACF;IACF,GAAG;QAACG;QAAUH;QAAoBT;KAAe;IAEjD,OAAO;QAAEsB;QAAgBlB;IAAS;AACpC"}